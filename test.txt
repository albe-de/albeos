#include "kernel_tools/including/vega.h"
#include "kernel_tools/including/string.h"

#define MULTIBOOT_MAGIC     0x1BADB002
#define MULTIBOOT_FLAGS     0x0
#define MULTIBOOT_CHECKSUM  (-(MULTIBOOT_MAGIC + MULTIBOOT_FLAGS))

// Multiboot header
__attribute__((section(".multiboot"), used))
const unsigned int multiboot_header[] = {
    MULTIBOOT_MAGIC,      // magic number
    MULTIBOOT_FLAGS,      // flags
    MULTIBOOT_CHECKSUM     // checksum (magic + flags + checksum = 0)
};


/************************************************
 *              KEYBOARD CONTROLLER
 *////////////////////////////////////////////////

static unsigned char last_scancode = 0;
static inline unsigned char inb(unsigned short port) {
    unsigned char ret;
    __asm__ volatile ("inb %1, %0" : "=a"(ret) : "Nd"(port));
    return ret;
}

#define KEYBOARD_DATA_PORT 0x60
#define ENTER_KEY 28
#define BACKSPACE_KEY 14

char current_key;
static const char keymap[128] = {
    0,  27, '1','2','3','4','5','6','7','8','9','0','-','=', '\b',
    '\t','q','w','e','r','t','y','u','i','o','p','[',']','\n', 0,
    'a','s','d','f','g','h','j','k','l',';','\'','`', 0,'\\',
    'z','x','c','v','b','n','m',',','.','/', 0, '*', 0,' ', 0,
};

void keyboard(){
    unsigned char scancode = inb(KEYBOARD_DATA_PORT);

    if (scancode & 0x80) last_scancode = scancode;
    if (scancode != last_scancode) {
        last_scancode = scancode;
        current_key = keymap[scancode];
        write_char(current_key);
    }
}

/************************************************
*             FINAL KEYBOARD CONTROLLER
*////////////////////////////////////////////////


void initialize_kernel(){
    clear_screen();
    write("Welcome to Alsh!\n\n");
    write_char(' ');
}

void kernel_main() {
    initialize_kernel();

    for(;;){
        keyboard();
    }
}
